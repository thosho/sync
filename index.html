<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #player { width: 100%; aspect-ratio: 16 / 9; border-radius: 0.5rem; }
        .chat-message, .system-message { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; translateY(0); } }
        .lds-ring { display: inline-block; position: relative; width: 20px; height: 20px; }
        .lds-ring div { box-sizing: border-box; display: block; position: absolute; width: 16px; height: 16px; margin: 2px; border: 2px solid #fff; border-radius: 50%; animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: #fff transparent transparent transparent; }
        .lds-ring div:nth-child(1) { animation-delay: -0.45s; } .lds-ring div:nth-child(2) { animation-delay: -0.3s; } .lds-ring div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes lds-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- Initial View -->
        <div id="initial-view" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md mx-auto">
            <h1 class="text-3xl font-extrabold mb-6 text-center">Sync</h1>
            <div class="space-y-4">
                <input type="text" id="session-title-input" placeholder="Create a Title for your Session" class="w-full bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="create-room-btn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 px-4 rounded-md transition flex items-center justify-center">Create New Room</button>
                 <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div><span class="flex-shrink mx-4 text-gray-500 dark:text-gray-400">OR</span><div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div></div>
                <input type="text" id="join-room-id-input" placeholder="Enter Host's Room ID to Join" class="w-full bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="join-room-btn" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-md transition flex items-center justify-center">Join Room</button>
            </div>
            <p id="status-text" class="text-sm text-center text-gray-500 dark:text-gray-400 mt-4 h-5"></p>
        </div>

        <!-- Main View -->
        <div id="main-view" class="hidden">
            <header class="mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 id="session-title-display" class="text-2xl font-bold"></h1>
                    <div class="flex items-center text-sm">
                        <span class="text-gray-500 dark:text-gray-400 mr-2">Room ID:</span>
                        <span id="room-id-display" class="font-mono text-blue-600 dark:text-blue-400"></span>
                        <button id="copy-room-id-btn" title="Copy Room ID" class="ml-2 text-gray-500 hover:text-blue-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg></button>
                    </div>
                </div>
                <button id="leave-room-btn" class="mt-3 md:mt-0 w-full md:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition">Leave Room</button>
            </header>
            
            <div id="host-video-controls" class="hidden mb-4 flex flex-col sm:flex-row gap-2 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                <input type="text" id="video-url-input" placeholder="Host: Paste YouTube URL" class="flex-grow bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2 focus:outline-none ring-blue-500">
                <button id="load-video-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Load Video</button>
            </div>
            
            <div id="player-container" class="bg-black rounded-lg mb-4 shadow-lg"><div id="player"></div></div>
            
            <div id="chat-container" class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-lg">
                <div class="flex justify-between items-center mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">
                    <h2 class="text-xl font-semibold">Live Discussion</h2>
                    <div class="flex items-center space-x-2">
                        <button id="watchers-btn" class="text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 font-medium py-1 px-3 rounded-md">Watchers (<span id="user-count">0</span>)</button>
                        <button id="export-chat-btn" class="text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 font-medium py-1 px-3 rounded-md">Export Chat</button>
                    </div>
                </div>
                <div id="chat-messages" class="h-64 overflow-y-auto mb-3 pr-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="username-input" placeholder="Your Name" class="w-1/3 bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2 focus:outline-none ring-blue-500">
                    <input type="text" id="chat-input" placeholder="Say something..." class="flex-grow bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2 focus:outline-none ring-blue-500">
                    <button id="send-chat-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/></svg></button>
                </div>
            </div>
        </div>
        
        <!-- Watchers Modal -->
        <div id="watchers-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Who's Watching</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <ul id="modal-user-list" class="space-y-3"></ul>
            </div>
        </div>

        <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-3 transition-all duration-300"></div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- State Management ---
        let peer, player, isHost = false, hostId = null, myPeerId = null;
        let connections = new Map();
        let sessionState = { title: "Watch Party", videoId: null, users: [] };
        let localState = { username: "", isPlayerReady: false, lastHostState: -1, syncInProgress: false };
        const loadingSpinner = `<div class="lds-ring"><div></div><div></div><div></div><div></div></div>`;

        // --- DOM Elements ---
        const $ = (id) => document.getElementById(id);
        const initialView = $('initial-view'), mainView = $('main-view'), statusText = $('status-text');
        const createRoomBtn = $('create-room-btn'), joinRoomBtn = $('join-room-btn'), leaveRoomBtn = $('leave-room-btn');
        const sessionTitleInput = $('session-title-input'), joinRoomIdInput = $('join-room-id-input');
        const sessionTitleDisplay = $('session-title-display'), roomIdDisplay = $('room-id-display');
        const hostVideoControls = $('host-video-controls'), videoUrlInput = $('video-url-input'), loadVideoBtn = $('load-video-btn');
        const userCount = $('user-count'), chatMessages = $('chat-messages'), usernameInput = $('username-input'), chatInput = $('chat-input'), sendChatBtn = $('send-chat-btn');
        const watchersBtn = $('watchers-btn'), exportChatBtn = $('export-chat-btn'), watchersModal = $('watchers-modal'), closeModalBtn = $('close-modal-btn'), modalUserList = $('modal-user-list');
        
        // --- YOUTUBE API ---
        window.onYouTubeIframeAPIReady = () => {
            localState.isPlayerReady = true;
        };

        function createPlayer(videoId) {
            if (player) { player.destroy(); }
            player = new YT.Player('player', {
                height: '390', width: '640', videoId: videoId || 'dQw4w9WgXcQ', // Default video
                playerVars: { 'playsinline': 1, 'rel': 0, 'autoplay': 1, 'controls': isHost ? 1 : 0 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }
        
        function onPlayerReady(event) { if (isHost) event.target.playVideo(); }

        function onPlayerStateChange(event) {
            if (!isHost || localState.syncInProgress) return;
            const state = event.data;
            // Only broadcast significant changes to avoid spamming
            if (state !== localState.lastHostState) {
                localState.lastHostState = state;
                broadcast({ type: 'playback-sync', state: state, time: player.getCurrentTime() });
            }
        }

        // --- P2P CORE LOGIC ---
        function initializePeerJS(asHost) {
            if (!localState.isPlayerReady) { setStatus('Player API not ready, please wait...'); return; }
            setLoading(true, asHost ? createRoomBtn : joinRoomBtn);
            if (peer) peer.destroy();
            peer = new Peer();

            peer.on('open', id => {
                myPeerId = id;
                localState.username = usernameInput.value.trim() || `User-${id.substring(0,4)}`;
                sessionState.users.push({ id: myPeerId, username: localState.username });
                if (asHost) setupHost(); else setupGuest();
            });
            peer.on('error', err => {
                setStatus(`Error: ${err.message}. Please refresh.`);
                setLoading(false, asHost ? createRoomBtn : joinRoomBtn);
            });
        }

        function setupHost() {
            isHost = true;
            hostId = myPeerId;
            sessionState.title = sessionTitleInput.value.trim() || "My Watch Party";
            peer.on('connection', conn => handleConnection(conn));
            showView(false);
            createPlayer(null);
            updateUI();
        }

        function setupGuest() {
            hostId = joinRoomIdInput.value.trim();
            if (!hostId) { setStatus('Host ID is required.'); setLoading(false, joinRoomBtn); return; }
            const conn = peer.connect(hostId, { metadata: { username: localState.username } });
            handleConnection(conn);
        }

        function handleConnection(conn) {
            connections.set(conn.peer, conn);
            
            conn.on('open', () => {
                if (isHost) { // Guest connected to host
                    const newUser = { id: conn.peer, username: conn.metadata.username };
                    sessionState.users.push(newUser);
                    addSystemMessage(`${newUser.username} has joined.`);
                    broadcast({ type: 'user-list-update', users: sessionState.users }, conn.peer);
                    conn.send({ type: 'sync-state', state: sessionState });
                    updateUI();
                }
            });
            
            conn.on('data', data => onDataReceived(conn, data));

            conn.on('close', () => {
                const disconnectedUser = sessionState.users.find(u => u.id === conn.peer);
                if(disconnectedUser) {
                    addSystemMessage(`${disconnectedUser.username} has left.`);
                    sessionState.users = sessionState.users.filter(u => u.id !== conn.peer);
                    broadcast({ type: 'user-list-update', users: sessionState.users });
                }
                connections.delete(conn.peer);
                updateUI();
            });
        }
        
        function onDataReceived(conn, data) {
            switch(data.type) {
                case 'sync-state': sessionState = data.state; showView(false); createPlayer(sessionState.videoId); updateUI(); break;
                case 'user-list-update': sessionState.users = data.users; updateUI(); break;
                case 'video-change': sessionState.videoId = data.videoId; createPlayer(data.videoId); break;
                case 'playback-sync': 
                    if (!isHost && player) {
                        localState.syncInProgress = true;
                        player.seekTo(data.time, true);
                        if (data.state === YT.PlayerState.PLAYING) player.playVideo();
                        else if (data.state === YT.PlayerState.PAUSED) player.pauseVideo();
                        setTimeout(() => localState.syncInProgress = false, 500);
                    }
                    break;
                case 'chat': addChatMessage(data.message, false); break;
                case 'system': addSystemMessage(data.text); break;
            }
        }
        
        function broadcast(data, excludePeerId = null) {
            for (const [peerId, conn] of connections.entries()) {
                if (peerId !== excludePeerId) conn.send(data);
            }
        }

        // --- UI & APP LOGIC ---
        function showView(isInitial) {
            setLoading(false, createRoomBtn); setLoading(false, joinRoomBtn);
            initialView.classList.toggle('hidden', !isInitial);
            mainView.classList.toggle('hidden', isInitial);
        }
        
        function updateUI() {
            userCount.textContent = sessionState.users.length;
            const userHtml = sessionState.users.map(user => `
                <li class="flex items-center space-x-3 p-2 rounded-md ${user.id === myPeerId ? 'bg-blue-50 dark:bg-blue-900/50' : ''}">
                    <span class="w-2.5 h-2.5 rounded-full ${user.id === myPeerId || connections.has(user.id) ? 'bg-green-500' : 'bg-gray-400'}"></span>
                    <span class="font-medium">${user.username} ${user.id === hostId ? '<span class="text-xs font-normal text-yellow-500">(Host)</span>' : ''}</span>
                </li>`).join('');
            modalUserList.innerHTML = userHtml;
            
            hostVideoControls.classList.toggle('hidden', !isHost);
            sessionTitleDisplay.textContent = sessionState.title;
            roomIdDisplay.textContent = hostId;
        }

        function loadVideo() {
            const url = videoUrlInput.value.trim();
            const videoId = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/)?. [1];
            if (videoId) {
                sessionState.videoId = videoId;
                createPlayer(videoId);
                broadcast({ type: 'video-change', videoId });
            } else {
                alert('Invalid YouTube URL. Please use a full YouTube video link.');
            }
        }

        function sendChatMessage() {
            localState.username = usernameInput.value.trim() || `User-${myPeerId.substring(0,4)}`;
            const text = chatInput.value.trim();
            if (!text) return;
            const message = { username: localState.username, text, timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) };
            addChatMessage(message, true);
            broadcast({ type: 'chat', message });
            chatInput.value = '';
        }

        function addChatMessage(msg, isMe) {
            const div = document.createElement('div');
            div.className = `chat-message mb-3 max-w-lg ${isMe ? 'ml-auto text-right' : 'mr-auto text-left'}`;
            div.innerHTML = `<div class="p-3 rounded-lg inline-block ${isMe ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700'}"><p class="font-bold text-sm">${msg.username}</p><p>${msg.text}</p></div><p class="text-xs text-gray-400 mt-1">${msg.timestamp}</p>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'system-message text-center my-2';
            div.innerHTML = `<span class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-medium px-2.5 py-0.5 rounded-full">${text}</span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            if(isHost) broadcast({type: 'system', text: text});
        }
        
        function exportChat() {
            const chatLog = Array.from(chatMessages.children).map(el => {
                if (el.classList.contains('system-message')) return `--- ${el.textContent.trim()} ---`;
                const username = el.querySelector('.font-bold')?.textContent || '';
                const text = el.querySelector('p:not(.font-bold)')?.textContent || '';
                const time = el.querySelector('.text-xs')?.textContent || '';
                return `[${time}] ${username}: ${text}`;
            }).join('\n');
            const header = `Session: ${sessionState.title}\nVideo: https://youtu.be/${sessionState.videoId}\nExported: ${new Date().toLocaleString()}\n\n`;
            const blob = new Blob([header + chatLog], { type: 'text/plain' });
            const anchor = document.createElement('a');
            anchor.download = `watch-party-${hostId}.txt`;
            anchor.href = URL.createObjectURL(blob);
            anchor.click();
            URL.revokeObjectURL(anchor.href);
        }

        // --- UTILITIES & EVENT LISTENERS ---
        function setLoading(isLoading, button) {
            button.disabled = isLoading;
            button.innerHTML = isLoading ? loadingSpinner + `<span class="ml-2">Connecting...</span>` : (button.id.includes('create') ? 'Create New Room' : 'Join Room');
        }
        
        function showToast(message) {
            const toast = $('toast');
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-3');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-3'), 3000);
        }
        
        createRoomBtn.addEventListener('click', () => initializePeerJS(true));
        joinRoomBtn.addEventListener('click', () => initializePeerJS(false));
        leaveRoomBtn.addEventListener('click', () => window.location.reload());
        loadVideoBtn.addEventListener('click', loadVideo);
        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', e => e.key === 'Enter' && sendChatMessage());
        usernameInput.addEventListener('change', () => localStorage.setItem('watchPartyUsername', usernameInput.value));
        exportChatBtn.addEventListener('click', exportChat);
        copyRoomIdBtn.addEventListener('click', () => { navigator.clipboard.writeText(hostId); showToast('Room ID copied!'); });
        watchersBtn.addEventListener('click', () => watchersModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => watchersModal.classList.add('hidden'));
        
        // --- On Load ---
        usernameInput.value = localStorage.getItem('watchPartyUsername') || '';
    </script>
</body>
</html>

