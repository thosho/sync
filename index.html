<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncWave - YouTube Watch Party</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #player-container { position: relative; width: 100%; aspect-ratio: 16 / 9; background-color: #000; border-radius: 0.5rem; }
        #player { width: 100%; height: 100%; }
        .chat-message, .system-message { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; translateY(0); } }
        .lds-ring { display: inline-block; position: relative; width: 20px; height: 20px; }
        .lds-ring div { box-sizing: border-box; display: block; position: absolute; width: 16px; height: 16px; margin: 2px; border: 2px solid #fff; border-radius: 50%; animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: #fff transparent transparent transparent; }
        .lds-ring div:nth-child(1) { animation-delay: -0.45s; } .lds-ring div:nth-child(2) { animation-delay: -0.3s; } .lds-ring div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes lds-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- Initial View -->
        <div id="initial-view" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md mx-auto">
            <h1 class="text-3xl font-extrabold mb-2 text-center">SyncWave</h1>
            <p class="text-gray-600 dark:text-gray-400 mb-6 text-center">Perfectly synced YouTube watch parties.</p>
            <div class="space-y-4">
                <input type="text" id="username-input-initial" placeholder="Enter Your Name" class="w-full bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <hr class="border-gray-300 dark:border-gray-600">
                <p class="font-bold text-lg text-center">Create a Room</p>
                <input type="text" id="session-title-input" placeholder="Title for your Session" class="w-full bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2">
                <div class="flex items-center justify-center space-x-4 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <span>Public</span>
                    <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="room-type-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-300 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div></label>
                    <span>Private</span>
                </div>
                <button id="create-room-btn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-md transition-opacity opacity-50 cursor-not-allowed" disabled>Create New Room</button>
                <hr class="border-gray-300 dark:border-gray-600">
                <p class="font-bold text-lg text-center">Join a Room</p>
                <input type="text" id="join-room-id-input" placeholder="Enter Host's Room ID" class="w-full bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2">
                <button id="join-room-btn" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-md transition-opacity opacity-50 cursor-not-allowed" disabled>Join Room</button>
            </div>
            <p id="status-text" class="text-sm text-center text-gray-500 dark:text-gray-400 mt-4 h-5">Initializing Player...</p>
        </div>

        <!-- Main View -->
        <div id="main-view" class="hidden">
            <header class="mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 id="session-title-display" class="text-2xl font-bold"></h1>
                    <div class="flex items-center text-sm">
                        <span class="text-gray-500 dark:text-gray-400 mr-2">Room ID:</span>
                        <span id="room-id-display" class="font-mono text-blue-600 dark:text-blue-400"></span>
                        <button id="copy-room-id-btn" title="Copy Room ID" class="ml-2 text-gray-500 hover:text-blue-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg></button>
                    </div>
                </div>
                <button id="leave-room-btn" class="mt-3 md:mt-0 w-full md:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition">Leave Room</button>
            </header>
            
            <div id="host-controls" class="hidden mb-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md space-y-3">
                 <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="video-url-input" placeholder="Host: Paste any YouTube video URL" class="flex-grow bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2">
                    <button id="load-video-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Load Video</button>
                </div>
                 <div id="host-panel" class="hidden bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">Private Room Codes</h3>
                    <button id="generate-codes-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md mb-2">Generate 5 Access Codes</button>
                    <div id="access-codes-list" class="text-sm space-y-1"></div>
                </div>
            </div>
            
            <div id="player-container" class="mb-4 shadow-lg"><div id="player"></div></div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-lg">
                <div class="flex justify-between items-center mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">
                    <h2 class="text-xl font-semibold">Live Discussion</h2>
                    <div class="flex items-center space-x-2">
                        <button id="viewers-btn" class="text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 font-medium py-1 px-3 rounded-md">Viewers (<span id="user-count">0</span>)</button>
                        <button id="export-chat-btn" class="text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 font-medium py-1 px-3 rounded-md">Export Chat</button>
                    </div>
                </div>
                <div id="chat-messages" class="h-64 overflow-y-auto mb-3 pr-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Say something..." class="flex-grow bg-gray-100 dark:bg-gray-700 rounded-md px-4 py-2">
                    <button id="send-chat-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/></svg></button>
                </div>
            </div>
        </div>
        
        <div id="viewers-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Who's Watching</h3><button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>
                <ul id="modal-user-list" class="space-y-3"></ul>
            </div>
        </div>

        <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-3 transition-all duration-300"></div>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- State ---
        let peer, player, isHost = false, hostId = null, myPeerId = null;
        let connections = new Map();
        let sessionState = { title: "Watch Party", videoId: null, isPrivate: false, accessCodes: [], users: [], chat: [] };
        let localState = { username: "", connectionTimeout: null, lastHostState: -1, syncInProgress: false, hostSeekInterval: null };
        const loadingSpinner = `<div class="lds-ring"><div></div><div></div><div></div><div></div></div>`;

        // --- DOM Elements ---
        const $ = (id) => document.getElementById(id);
        const initialView = $('initial-view'), mainView = $('main-view'), statusText = $('status-text');
        const usernameInputInitial = $('username-input-initial');
        const createRoomBtn = $('create-room-btn'), joinRoomBtn = $('join-room-btn'), leaveRoomBtn = $('leave-room-btn');
        const sessionTitleInput = $('session-title-input'), roomTypeToggle = $('room-type-toggle'), joinRoomIdInput = $('join-room-id-input');
        const sessionTitleDisplay = $('session-title-display'), roomIdDisplay = $('room-id-display');
        const hostControls = $('host-controls'), videoUrlInput = $('video-url-input'), loadVideoBtn = $('load-video-btn');
        const hostPanel = $('host-panel'), generateCodesBtn = $('generate-codes-btn'), accessCodesList = $('access-codes-list');
        const userCount = $('user-count'), chatMessages = $('chat-messages'), chatInput = $('chat-input'), sendChatBtn = $('send-chat-btn');
        const viewersBtn = $('viewers-btn'), exportChatBtn = $('export-chat-btn'), viewersModal = $('viewers-modal'), closeModalBtn = $('close-modal-btn'), modalUserList = $('modal-user-list');
        const toast = $('toast');
        
        // --- YouTube API ---
        window.onYouTubeIframeAPIReady = () => {
            setStatus('Player ready. You can now create or join a room.');
            createRoomBtn.disabled = false;
            joinRoomBtn.disabled = false;
            createRoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            joinRoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        };

        function createPlayer(videoId) {
            if (player) { player.destroy(); }
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'playsinline': 1, 'rel': 0, 'autoplay': 1, 'controls': isHost ? 1 : 0 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }
        
        function onPlayerReady(event) { if (isHost) event.target.playVideo(); }

        function onPlayerStateChange(event) {
            if (!isHost || localState.syncInProgress) return;
            const state = event.data;
            if (state !== localState.lastHostState) {
                localState.lastHostState = state;
                broadcast({ type: 'playback-state', state: state });
            }
            if (state === YT.PlayerState.PLAYING) {
                if(localState.hostSeekInterval) clearInterval(localState.hostSeekInterval);
                localState.hostSeekInterval = setInterval(() => {
                    broadcast({ type: 'playback-time', time: player.getCurrentTime() });
                }, 1000);
            } else {
                 if(localState.hostSeekInterval) clearInterval(localState.hostSeekInterval);
            }
        }

        // --- P2P Logic ---
        function initializePeerJS(asHost) {
            localState.username = usernameInputInitial.value.trim();
            if (!localState.username) { setStatus('Please enter your name.'); return; }
            localStorage.setItem('syncwave_username', localState.username);
            
            setLoading(true, asHost ? createRoomBtn : joinRoomBtn);
            if (peer) peer.destroy();
            
            clearTimeout(localState.connectionTimeout);
            localState.connectionTimeout = setTimeout(() => {
                setStatus('Connection timed out. Please try again.');
                setLoading(false, asHost ? createRoomBtn : joinRoomBtn);
                if (peer) peer.destroy();
            }, 8000);

            peer = new Peer();

            peer.on('open', id => {
                clearTimeout(localState.connectionTimeout);
                myPeerId = id;
                if (!sessionState.users.some(u => u.id === myPeerId)) {
                    sessionState.users.push({ id: myPeerId, username: localState.username });
                }
                if (asHost) setupHost(); else setupGuest();
            });
            peer.on('error', err => {
                clearTimeout(localState.connectionTimeout);
                setStatus(`Error: ${err.message}. Please refresh.`);
                setLoading(false, asHost ? createRoomBtn : joinRoomBtn);
            });
        }

        function setupHost() {
            isHost = true; hostId = myPeerId;
            sessionState.title = sessionTitleInput.value.trim() || "My Watch Party";
            sessionState.isPrivate = roomTypeToggle.checked;
            peer.on('connection', conn => handleConnection(conn));
            showView(false); createPlayer(null); updateUI();
        }

        function setupGuest() {
            hostId = joinRoomIdInput.value.trim();
            if (!hostId) { setStatus('Host ID is required.'); setLoading(false, joinRoomBtn); return; }
            const conn = peer.connect(hostId, { metadata: { username: localState.username } });
            handleConnection(conn);
        }

        function handleConnection(conn) {
            connections.set(conn.peer, conn);
            conn.on('open', () => { if (isHost) { if (sessionState.isPrivate) conn.send({ type: 'auth-request' }); else addAndSyncUser(conn, conn.metadata.username); } });
            conn.on('data', data => onDataReceived(conn, data));
            conn.on('close', () => onUserDisconnect(conn));
        }
        
        function onDataReceived(conn, data) {
            switch(data.type) {
                case 'auth-code':
                    const code = sessionState.accessCodes.find(c => c.code === data.code && !c.usedBy);
                    if(code) { code.usedBy = conn.peer; conn.send({ type: 'auth-success' }); addAndSyncUser(conn, conn.metadata.username); } 
                    else { conn.send({ type: 'auth-fail' }); setTimeout(() => conn.close(), 500); }
                    break;
                case 'auth-request':
                    const userCode = prompt("This room is private. Please enter the access code:");
                    if(userCode) conn.send({type: 'auth-code', code: userCode.trim().toUpperCase()}); else conn.close();
                    break;
                case 'auth-success': conn.send({type: 'sync-request'}); break;
                case 'auth-fail': alert('Invalid access code.'); leaveRoom(); break;
                case 'sync-request': conn.send({ type: 'sync-state', state: sessionState }); break;
                case 'sync-state': sessionState = data.state; showView(false); createPlayer(sessionState.videoId); updateUI(); break;
                case 'user-list-update': sessionState.users = data.users; updateUI(); break;
                case 'video-change': sessionState.videoId = data.videoId; createPlayer(data.videoId); break;
                case 'playback-state': if (!isHost && player) { if (data.state === YT.PlayerState.PLAYING) player.playVideo(); else if (data.state === YT.PlayerState.PAUSED) player.pauseVideo(); } break;
                case 'playback-time': if (!isHost && player) { const timeDiff = Math.abs(player.getCurrentTime() - data.time); if (timeDiff > 2.5) { player.seekTo(data.time, true); } } break;
                case 'chat': sessionState.chat.push(data.message); updateUI(); break;
                case 'system': sessionState.chat.push(data.message); updateUI(); break;
            }
        }
        
        function addAndSyncUser(conn, username) {
            const newUser = { id: conn.peer, username };
            if(!sessionState.users.some(u => u.id === newUser.id)) sessionState.users.push(newUser);
            addSystemMessage(`${username} has joined.`);
            conn.send({ type: 'sync-state', state: sessionState });
            broadcast({ type: 'user-list-update', users: sessionState.users }, conn.peer);
            updateUI();
        }

        function onUserDisconnect(conn) {
            const user = sessionState.users.find(u => u.id === conn.peer);
            if(user) { addSystemMessage(`${user.username} has left.`); sessionState.users = sessionState.users.filter(u => u.id !== conn.peer); broadcast({ type: 'user-list-update', users: sessionState.users }); }
            connections.delete(conn.peer);
            updateUI();
        }
        
        function broadcast(data, excludePeerId = null) {
            for (const [peerId, conn] of connections.entries()) { if (peerId !== excludePeerId) conn.send(data); }
        }

        // --- UI & APP Logic ---
        function showView(isInitial) {
            setLoading(false, createRoomBtn); setLoading(false, joinRoomBtn);
            initialView.classList.toggle('hidden', !isInitial);
            mainView.classList.toggle('hidden', isInitial);
        }
        
        function updateUI() {
            userCount.textContent = sessionState.users.length;
            modalUserList.innerHTML = sessionState.users.map(user => `<li class="flex items-center space-x-3 p-2 rounded-md ${user.id === myPeerId ? 'bg-blue-50 dark:bg-blue-900/50' : ''}"><span class="w-2.5 h-2.5 rounded-full ${user.id === myPeerId || connections.has(user.id) ? 'bg-green-500' : 'bg-gray-400'}"></span><span class="font-medium">${user.username} ${user.id === hostId ? '<span class="text-xs font-normal text-yellow-500">(Host)</span>' : ''}</span></li>`).join('');
            hostControls.classList.toggle('hidden', !isHost);
            hostPanel.classList.toggle('hidden', !isHost || !sessionState.isPrivate);
            if(isHost) { accessCodesList.innerHTML = sessionState.accessCodes.map(c => `<div class="flex justify-between items-center p-1 rounded ${c.usedBy ? 'bg-gray-200 dark:bg-gray-600' : 'bg-gray-100 dark:bg-gray-700'}"><code class="${c.usedBy ? 'line-through text-gray-500' : ''}">${c.code}</code><span class="text-xs text-gray-400">${c.usedBy ? `Used` : 'Unused'}</span></div>`).join(''); }
            sessionTitleDisplay.textContent = sessionState.title;
            roomIdDisplay.textContent = hostId;

            chatMessages.innerHTML = '';
            sessionState.chat.forEach(msg => {
                const div = document.createElement('div');
                if (msg.isSystem) { div.className = 'system-message text-center my-2'; div.innerHTML = `<span class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-medium px-2.5 py-0.5 rounded-full">${msg.text}</span>`; } 
                else { div.className = 'chat-message mb-3 max-w-lg'; div.innerHTML = `<div class="p-3 rounded-lg inline-block bg-gray-200 dark:bg-gray-700"><p class="font-bold text-sm text-blue-400">${msg.username}</p><p>${msg.text}</p></div><p class="text-xs text-gray-400 mt-1">${msg.timestamp}</p>`; }
                chatMessages.appendChild(div);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function loadVideo() {
            const url = videoUrlInput.value.trim();
            const videoId = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/)?. [1];
            if (videoId) { sessionState.videoId = videoId; createPlayer(videoId); broadcast({ type: 'video-change', videoId }); } 
            else { alert('Invalid YouTube URL. Please use a full YouTube video link.'); }
        }

        function sendChatMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            const message = { username: localState.username, text, timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) };
            sessionState.chat.push(message);
            broadcast({ type: 'chat', message });
            updateUI();
            chatInput.value = '';
        }

        function addSystemMessage(text) {
            const message = { isSystem: true, text };
            sessionState.chat.push(message);
            if(isHost) broadcast({type: 'system', message});
            updateUI();
        }
        
        function generateCodes() {
            for (let i = 0; i < 5; i++) { sessionState.accessCodes.push({ code: Math.random().toString(36).substring(2, 8).toUpperCase(), usedBy: null }); }
            updateUI();
        }
        
        function exportChat() {
            if (sessionState.chat.length === 0) { showToast('Chat is empty, nothing to export.'); return; }
            const chatLog = sessionState.chat.map(msg => { if (msg.isSystem) return `--- ${msg.text} ---`; return `[${msg.timestamp}] ${msg.username}: ${msg.text}`; }).join('\n');
            const header = `Session: ${sessionState.title}\nVideo: https://youtu.be/${sessionState.videoId}\nExported: ${new Date().toLocaleString()}\n\n`;
            const blob = new Blob([header + chatLog], { type: 'text/plain' });
            const anchor = document.createElement('a');
            anchor.download = `syncwave-chat-${hostId}.txt`;
            anchor.href = URL.createObjectURL(blob);
            anchor.click();
            URL.revokeObjectURL(anchor.href);
        }
        
        function leaveRoom() { window.location.reload(); }
        function setStatus(text) { statusText.textContent = text; }
        function setLoading(isLoading, button) { button.disabled = isLoading; button.innerHTML = isLoading ? loadingSpinner + `<span class="ml-2">Connecting...</span>` : (button.id.includes('create') ? 'Create New Room' : 'Join Room'); }
        function showToast(message) { toast.textContent = message; toast.classList.remove('opacity-0', 'translate-y-3'); setTimeout(() => toast.classList.add('opacity-0', 'translate-y-3'), 3000); }
        
        // --- Event Listeners ---
        createRoomBtn.addEventListener('click', () => initializePeerJS(true));
        joinRoomBtn.addEventListener('click', () => initializePeerJS(false));
        leaveRoomBtn.addEventListener('click', leaveRoom);
        loadVideoBtn.addEventListener('click', loadVideo);
        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', e => e.key === 'Enter' && sendChatMessage());
        generateCodesBtn.addEventListener('click', generateCodes);
        copyRoomIdBtn.addEventListener('click', () => { navigator.clipboard.writeText(hostId); showToast('Room ID copied!'); });
        viewersBtn.addEventListener('click', () => viewersModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => viewersModal.classList.add('hidden'));
        exportChatBtn.addEventListener('click', exportChat);
        
        // --- On Load ---
        usernameInputInitial.value = localStorage.getItem('syncwave_username') || '';
    </script>
</body>
</html>

